{{- if .Values.istio.enabled }}
# =============================================================================
# APP-SERVICE VIRTUALSERVICE - Entry Point with 90/10 Canary Split
# =============================================================================
# DYNAMIC ROUTING DECISION: 90/10 weighted split happens HERE
#
# This is the primary routing decision point for external traffic.
# DestinationRule defines subsets (stable/canary) with consistentHash
# for sticky sessions based on x-user-id header.
#
# Traffic Flow:
#   1. External request → Gateway → THIS VirtualService
#   2. ROUTING DECISION: 90% → stable (v1), 10% → canary (v2)
#   3. DestinationRule ensures consistent routing per user (sticky sessions)
# =============================================================================
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: app-service-virtualservice
spec:
  hosts:
    - {{ .Values.hostname | quote }}
  gateways:
    - {{ .Release.Name }}-gateway

  http:
    # Simple canary route for testing
    - match:
        - headers:
            x-user-id:
              exact: "user-canary"
      route:
        - destination:
            host: app-service
            subset: canary
            port:
              number: {{ .Values.appService.service.port }}

    # ==========================================================================
    # DYNAMIC ROUTING DECISION: 90/10 canary split
    # ==========================================================================
    # 90% of traffic → stable (v1-stable)
    # 10% of traffic → canary (v2-canary)
    # The consistentHash in DestinationRule ensures users stick to their assigned version
    # ==========================================================================
    - route:
        - destination:
            host: app-service
            subset: stable
            port:
              number: {{ .Values.appService.service.port }}
          weight: 90
          headers:
            request:
              add:
                x-session-hash: "%REQ(x-user-id)%"
        - destination:
            host: app-service
            subset: canary
            port:
              number: {{ .Values.appService.service.port }}
          weight: 10
          headers:
            request:
              add:
                x-session-hash: "%REQ(x-user-id)%"
{{- end }}
