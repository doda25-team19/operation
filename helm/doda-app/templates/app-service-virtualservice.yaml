{{- if .Values.istio.enabled }}
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: app-service-virtualservice
spec:
  hosts:
    {{- range .Values.istio.virtualService.hosts }}
    - {{ . | quote }}
    {{- end }}

  gateways:
    - {{ .Release.Name }}-gateway

  http:
    # Simple canary route for testing
    - match:
        - headers:
            x-user-id:
              exact: "user-canary"
      route:
        - destination:
            host: app-service
            subset: canary
            port:
              number: {{ .Values.appService.service.port }}
    
    # Default: everyone else goes to stable
    - route:
        - destination:
            host: app-service
            subset: stable
            port:
              number: {{ .Values.appService.service.port }}
{{- end }}